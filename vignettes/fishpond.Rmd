---
title: "Fishpond"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
author: "Anqi Zhu, Michael Love"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_float: true
vignette: |
  %\VignetteIndexEntry{Fishpond}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- run this document with library(rmarkdown); render("fishpond.Rmd") -->

```{r setup, echo=FALSE, results="hide"}
knitr::opts_chunk$set(tidy=FALSE, cache=TRUE,
                      dev="png",
                      message=FALSE, error=FALSE, warning=FALSE)
```

Here we use *tximport*, but eventually use *tximeta* to put
inferential replicates into a *SummarizedExperiment*.

```{r}
library(tximeta)
dir <- "../../quants"
subdir <- rep(c("bias","unif"), each=12)
names <- rep(as.vector(t(outer(1:6,1:2,function(x,y) paste0(x,"_",y)))),2)
files <- file.path(dir, subdir, names, "quant.sf")
all(file.exists(files))
condition <- factor(sub(".*_(.)","\\1",names))
batch <- factor(rep(1:2,each=12))
coldata <- data.frame(files, names, condition, batch)
txi <- tximeta(coldata, skipMeta=TRUE, txOut=TRUE)
```

```{r}
nreps <- ncol(txi$infReps[[1]])
all(sapply(txi$infReps, ncol) == nreps)
getCols <- function(j,l) do.call(cbind, lapply(seq_along(l), function(k)  l[[k]][,j]))
infReps <- lapply(seq_len(nreps), getCols, txi$infReps)
names(infReps) <- seq_len(nreps)
meanDepth <- exp(mean(log(colSums(txi$counts))))
infRepsAbund <- medianRatioScaledTPM(infReps, txi$length, meanDepth)
```

```{r}
suppressPackageStartupMessages(library(SummarizedExperiment))
y <- SummarizedExperiment(assays=infRepsAbund)

```

```{r}
y <- pool(y, "condition", "batch")
```

```{r}
y <- soggy(y, "condition")
```
